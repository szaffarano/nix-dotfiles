* NixOS Based dotfiles
:PROPERTIES:
:CUSTOM_ID: nixos-based-dotfiles
:END:
[[https://github.com/szaffarano/nix-dotfiles/actions/workflows/pre-commit.yml][[[https://github.com/szaffarano/nix-dotfiles/actions/workflows/pre-commit.yml/badge.svg]]]]

** Bootstrap
:PROPERTIES:
:CUSTOM_ID: bootstrap
:END:
*** Preconditions
:PROPERTIES:
:CUSTOM_ID: preconditions
:END:
1. Create a keypair for the target machine

   #+begin_example
    ssh-keygen -t ed25519 -C <some comment> -f ssh_host_ed25519_key
   #+end_example

2. Generate an age recipient using the above public key (using the
   [[https://github.com/Mic92/ssh-to-age][ssh-to-age]] tool)

   #+begin_example
    ssh-to-age  -i ssh_host_ed25519_key.pub -o <machine-name>.age.pub.txt
   #+end_example

3. Update the [[./.sops.yaml][.sops.yaml]] configuration file adding the
   age recipient.

4. Generate secrets for this machine using both the root's and your own
   recipient. Example for the OS user:

   #+begin_example
       # copy the output
        echo "<password>" | mkpasswd -s

        # add or edit the secrets.yaml file
        sops system/<machine-name>/secrets.yaml
   #+end_example

*** New machine configuration
:PROPERTIES:
:CUSTOM_ID: new-machine-configuration
:END:
1. Based on an existent configuration, create a new one under
   [[./system][system]], e.g., =./system/<machine-name>/default.nix=.
   Pay attention to the
   [[https://github.com/nix-community/disko][disko]] configuration file
   to avoid any hard-to-recover mistake.

2. Same as above but with home-manager configurations, under
   [[./users][users]], e.g., =./users/<user-name>/<machine-name>.nix=

3. Boot the new machine using
   [[https://github.com/nix-community/nixos-anywhere][nixos-anywhere]].
   Eventually you would need to install rsync, =nix-env -iA nixos.rsync=

4. Run nixos-anywhere including the ssh keys generated as preconditions

   #+begin_example
    ❯ tree /path/to/ssh/key
    /path/to/ssh/key
    └── etc
        └── ssh
            └── ssh_host_ed25519_key

    ❯ nix run github:nix-community/nixos-anywhere -- \
        --flake .#<machine-name> \
        --extra-files /path/to/ssh/key root@<new-machine-ip>
   #+end_example

5. Once finished, login in the new machine, clone the repo and run
   home-manager

   #+begin_example
    ssh <user-name>@<new-machine-ip>
    git clone https://github.com/szaffarano/nix-dotfiles .dotfiles
    cd .dotfiles
    home-manager switch --flake .
   #+end_example

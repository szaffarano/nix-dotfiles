---
- name: "Change default user shell to {{ default_shell }}"
  become: true
  ansible.builtin.user:
    name: "{{ user_name }}"
    shell: "{{ default_shell }}"

- name: "Configure groups for {{ user_name }}"
  become: true
  ansible.builtin.user:
    name: "{{ user_name }}"
    groups: "{{ system_groups }}"
    append: true

- name: "Configure systemd services"
  become: true
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
  loop: "{{ systemd_services }}"
  notify:
    - Start systemd services

- name: >
    Load system config tasks for
    {{ ansible_distribution }} ({{ ansible_os_family }})
  ansible.builtin.include_tasks: "{{ item }}"
  with_first_found:
    - '{{ ansible_distribution }}.yml'
    - '{{ ansible_os_family }}.yml'
    - default.yml
  tags: tasks

- name: Configure udev rules for USB wakeup devices
  ansible.builtin.template:
    src: 90-usbwakeup.rules
    dest: /etc/udev/rules.d/
    mode: "0644"
  when: wakeup_devices is defined

- name: Disable wakeup using Lid
  ansible.builtin.template:
    src: disable-lid.conf
    dest: "/etc/tmpfiles.d/disable-{{ lid_name }}.conf"
    mode: "0644"
  when: lid_name is defined

- name: Enable FastConnectable blueetooth feature
  ansible.builtin.blockinfile:
    path: /etc/bluetooth/main.conf
    block: |
      FastConnectable = true
      ReconnectAttempts=7
      ReconnectIntervals=1,2,4,8,16,32
